{% extends "admin/layout.html" %} {% block title %}Dashboard{% endblock %} {%
block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h4 class="fw-bold mb-1">Dashboard</h4>
    <p class="text-muted mb-0">System overview and monitoring</p>
  </div>
  <div class="text-muted small">
    Welcome, <strong>{{ session.admin_name }}</strong>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex align-items-center">
        <div class="icon-box bg-primary text-white me-3">
          <i class="bi bi-people-fill"></i>
        </div>
        <div>
          <div class="text-muted small">Total Users</div>
          <div class="fs-3 fw-bold">{{ summary.total_users }}</div>
          <div class="text-success small">Registered users</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex align-items-center">
        <div class="icon-box bg-success text-white me-3">
          <i class="bi bi-activity"></i>
        </div>
        <div>
          <div class="text-muted small">Average BMI</div>
          <div class="fs-3 fw-bold">
            {{ summary.avg_bmi if summary.avg_bmi else "N/A" }}
          </div>
          <div class="text-muted small">
            {{ "Calculated" if summary.avg_bmi else "No data" }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex align-items-center">
        <div class="icon-box bg-warning text-white me-3">
          <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <div>
          <div class="text-muted small">Obesity Cases</div>
          <div class="fs-3 fw-bold">{{ summary.obesity_count }}</div>
          <div class="text-muted small">Detected users</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex align-items-center">
        <div class="icon-box bg-warning text-white me-3">
          <i class="bi bi-star-fill"></i>
        </div>
        <div>
          <div class="text-muted small">Avg. User Rating</div>
          <div class="fs-3 fw-bold" id="avg-rating-text">
            {{ summary.avg_user_rating if summary.avg_user_rating else '0.0' }}
          </div>
          <div class="text-muted small">User Satisfaction</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h6 class="fw-semibold mb-3">Posture Distribution</h6>
        <div class="empty-state text-center py-4">
          <i class="bi bi-pie-chart fs-1 text-muted"></i>
          <p class="mb-0">Posture distribution data will appear soon.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h6 class="fw-semibold mb-3">New Users Trend</h6>
        <div class="empty-state text-center py-4">
          <i class="bi bi-graph-up fs-1 text-muted"></i>
          <p class="mb-0">User growth analytics will be available soon.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-12">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h6 class="fw-semibold mb-0">
            User Satisfaction (Rating Distribution)
          </h6>
          <a
            href="{{ url_for('admin.view_reviews') }}"
            class="btn btn-sm btn-light border"
            >View All Reviews</a
          >
        </div>
        <div style="height: 300px; position: relative">
          <canvas id="reviewChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    try {
      // 1. Ambil data dari Flask
      const reviewData = JSON.parse("{{ chart_review_data | tojson | safe }}");
      const avgRating = parseFloat("{{ summary.avg_user_rating }}") || 0;

      // 2. Update Text Rata-rata (jika elemen ada)
      const avgTextElement = document.getElementById("avg-rating-text");
      if (avgTextElement) {
        avgTextElement.innerText = avgRating.toFixed(1);
      }

      // 3. Inisialisasi Chart
      const ctx = document.getElementById("reviewChart");
      if (ctx) {
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["1 Star", "2 Stars", "3 Stars", "4 Stars", "5 Stars"],
            datasets: [
              {
                label: "Total Reviews",
                data: reviewData,
                // Gunakan array warna untuk membedakan tiap bar (1 Star - 5 Stars)
                backgroundColor: [
                  "#dc3545", // 1 Star - Merah (Danger)
                  "#fd7e14", // 2 Stars - Oranye
                  "#ffc107", // 3 Stars - Kuning (Warning)
                  "#94d82d", // 4 Stars - Hijau Muda
                  "#198754", // 5 Stars - Hijau Tua (Success)
                ],
                borderRadius: 8,
                barThickness: 40,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
              },
            },
          },
        });
      }
    } catch (error) {
      console.error("Gagal merender grafik:", error);
    }
  });
</script>

{% endblock %}
