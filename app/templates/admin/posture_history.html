{% extends "admin/layout.html" %}

{% block title %}Posture Scan History{% endblock %}

{% block content %}

<!-- ===================== HEADER ===================== -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h4 class="fw-bold mb-0">Posture Scan History</h4>
    <small class="text-muted">Monitoring posture scan for selected user</small>
  </div>

  <a href="{{ url_for('admin.user_detail', user_id=user.id) }}"
     class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left"></i> Back
  </a>
</div>

<!-- ===================== TABLE ===================== -->
<div class="card shadow-sm border-0">
  <div class="card-body p-0">

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr class="text-muted small">
            <th class="ps-4">#</th>
            <th>Date</th>
            <th>Category</th>
            <th>Score</th>
            <th class="text-center">Keypoints</th>
          </tr>
        </thead>

        <tbody>
        {% for p in postures %}
          <tr
            data-bs-toggle="modal"
            data-bs-target="#keypointModal"
            data-keypoints="{{ p.keypoints | e }}"
            style="cursor:pointer"
          >
            <td class="ps-4 fw-semibold">{{ loop.index }}</td>

            <td>
              {{ p.created_at.strftime('%d %b %Y %H:%M') if p.created_at else '-' }}
            </td>

            <td>
              {% if p.category == 'normal' %}
                <span class="badge bg-success">Normal</span>
              {% elif p.category == 'warning' %}
                <span class="badge bg-warning text-dark">Warning</span>
              {% else %}
                <span class="badge bg-danger">Bad</span>
              {% endif %}
            </td>

            <td class="fw-semibold">{{ p.score }}</td>

            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary">
                View
              </button>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              No posture scan history available
            </td>
          </tr>
        {% endfor %}
        </tbody>

      </table>
    </div>

  </div>
</div>

<!-- ===================== MODAL ===================== -->
<div class="modal fade" id="keypointModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title fw-semibold">Keypoints Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <pre id="keypointsContent"
             class="small bg-light p-3 rounded mb-0"></pre>
      </div>

    </div>
  </div>
</div>

<!-- ===================== SCRIPT ===================== -->
<script>
  const modal = document.getElementById('keypointModal');

  modal.addEventListener('show.bs.modal', event => {
    const row = event.relatedTarget.closest('tr');
    const keypoints = row.getAttribute('data-keypoints');
    document.getElementById('keypointsContent').textContent = keypoints || '-';
  });
</script>

{% endblock %}
