{% extends "admin/layout.html" %}

{% block title %}Posture History - Admin{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h3>Posture History - {{ user.name }}</h3>
  <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="btn btn-secondary btn-sm">Back</a>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle shadow-sm">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>BMI</th>
        <th>Posture Category</th>
        <th>Score</th>
        <th>Keypoints</th>
      </tr>
    </thead>

    <tbody>
    {% for p in postures %}
      <tr data-bs-toggle="modal"
          data-bs-target="#keypointModal"
          data-keypoints="{{ p.keypoints | e }}">

        <td>{{ p.id }}</td>
        <td>{{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '' }}</td>
        <td>{{ p.bmi or '-' }}</td>
        <td>{{ p.posture_category or '-' }}</td>
        <td>{{ p.posture_score or '-' }}</td>
        <td>
          <button class="btn btn-sm btn-info">View</button>
        </td>
      </tr>
    {% else %}
      <tr>
        <td colspan="6" class="text-center text-muted">No posture history</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<!-- ===================== MODAL DETAIL KEYPOINT ===================== -->
<div class="modal fade" id="keypointModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Keypoints Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <pre id="keypointsContent" class="small mb-0"></pre>
      </div>

    </div>
  </div>
</div>

<!-- ===================== SCRIPT ===================== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const modal = document.getElementById('keypointModal');

  modal.addEventListener('show.bs.modal', event => {
    const row = event.relatedTarget.closest('tr');
    const kp = row.getAttribute('data-keypoints');
    document.getElementById('keypointsContent').textContent = kp;
  });
</script>

{% endblock %}
